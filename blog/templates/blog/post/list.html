{% extends "blog/base.html" %}
{% load blog_tags %}

{% block title %}My Blog{% endblock %}

{% block content %}

<div class="page-header">
  <h1 class="page-title">Latest Blog Posts</h1>

  <!-- âœ… SEARCH BUTTON -->
  <a href="{% url 'blog:post_search' %}" class="btn-search">
    <i class="fas fa-search"></i> Search
  </a>
</div>

{% if tag %}
  <p class="tag-filter">
    Showing posts tagged with <strong>#{{ tag.name }}</strong>
  </p>
{% endif %}

{% for post in posts %}
  <article class="post-card">
    <h2>
      <a href="javascript:void(0)"onclick="handlePostClick('{{ post.get_absolute_url }}', '{{ post.status }}', '{{ post.author.id }}')">
        {{ post.title }}
      </a>
      {% if post.status == "DF" %}
        <span class="draft-badge">DRAFT</span>
      {% endif %}
    </h2>


    <p class="date">
      Published {{ post.publish|date:"F j, Y" }} by {{ post.author }}
    </p>

    <div class="tags">
      {% for tag in post.tags.all %}
        <a href="{% url 'blog:post_list_by_tag' tag.slug %}">#{{ tag.name }}</a>
      {% endfor %}
    </div>

    <div class="summary">
      {{ post.body|markdown|truncatewords_html:30 }}
    </div>

    <div class="post-footer">
      <a class="btn-read-more" href="{{ post.get_absolute_url }}">
        Read More
      </a>
    </div>
  </article>
{% endfor %}

{% include "pagination.html" with page=posts %}

<script>
function handlePostClick(url, status, authorId) {
  const token = localStorage.getItem("access_token");
  const loggedInUserId = localStorage.getItem("user_id"); // set on login

  if (status === "DF") {
    if (!token || loggedInUserId != authorId) {
      alert("ðŸš« This post is currently in draft.");
      return;
    }
  }

  window.location.href = url;
}
function openPost(url, status, authorId) {
  const token = localStorage.getItem("access_token");
  const userId = localStorage.getItem("user_id");

  if (status === "DF" && (!token || userId != authorId)) {
    alert("ðŸš« This post is currently in draft.");
    return;
  }

  window.location.href = url;
}
</script>

{% endblock %}
