{% extends "blog/base.html" %}
{% load static %}

{% block title %}Add New Blog{% endblock %}

{% block content %}
<div class="container">
  <div class="card">
    <h2>Create New Blog Post</h2>

    <form id="postForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" placeholder="Enter blog title" required>
      </div>

      <div class="form-group">
        <label for="body">Content</label>
        <textarea id="body" rows="6" placeholder="Write your post here..." required></textarea>
      </div>

      <!-- ✅ TAGS FIELD -->
      <div class="form-group">
        <label for="tags">Tags (comma separated)</label>
        <input type="text" id="tags" placeholder="django, drf, python">
      </div>

      <div class="form-group">
        <label for="status">Status</label>
        <select id="status">
          <option value="DF">Draft</option>
          <option value="PB">Publish</option>
        </select>
      </div>

      <button type="submit" class="btn-primary">
        <i class="fas fa-paper-plane"></i> Submit Post
      </button>

      <p id="message" class="message"></p>
    </form>
  </div>
</div>

<script>
const token = localStorage.getItem("access_token");

if (!token) {
  alert("You must be logged in to add a post.");
  window.location.href = "/login/";
}

document.getElementById("postForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const title = document.getElementById("title").value;
  const body = document.getElementById("body").value;
  const status = document.getElementById("status").value;

  // ✅ TAG HANDLING
  const tagsRaw = document.getElementById("tags").value;
  const tags = tagsRaw
    ? tagsRaw.split(",").map(tag => tag.trim()).filter(tag => tag)
    : [];

  const response = await fetch("/blog/api/posts/add/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({
      title: title,
      body: body,
      status: status,
      tags: tags
    })
  });

  const data = await response.json();
  const messageEl = document.getElementById("message");

  if (response.ok) {
    messageEl.style.color = "green";
    messageEl.innerText = "Post created successfully!";
    setTimeout(() => {
      window.location.href = "/blog/";
    }, 1200);
  } else {
    messageEl.style.color = "red";
    messageEl.innerText = JSON.stringify(data);
  }
});
</script>

<style>
.container {
  display: flex;
  justify-content: center;
  margin-top: 40px;
}

.card {
  width: 100%;
  max-width: 700px;
  background: #ffffff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.form-group {
  margin-bottom: 15px;
}

input, textarea, select {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.btn-primary {
  background: #4f46e5;
  color: white;
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.btn-primary:hover {
  background: #4338ca;
}

.message {
  margin-top: 10px;
}
</style>
{% endblock %}
